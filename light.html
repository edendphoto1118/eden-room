<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Light Sculptor Pro | EDEN LAB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Shippori+Mincho:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { serif: ['Cinzel', 'serif'], mono: ['Space Mono', 'monospace'], zh: ['Shippori Mincho', 'serif'] },
                    colors: { eden: { gold: '#D4AF37' } }
                }
            }
        }
    </script>

    <style>
        body { background-color: #050505; color: #C0C0C0; overflow-x: hidden; }
        #ui-layer { position: relative; z-index: 50; pointer-events: none; }
        #ui-layer nav, #ui-layer main, .interactive-el { pointer-events: auto; }
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 0; background: radial-gradient(circle at center, #1a1a1a 0%, #000000 90%); }
        
        /* 質感滑桿 */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; padding: 15px 0; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 14px; width: 14px; background: #D4AF37; margin-top: -6px; border: 1px solid #000; box-shadow: 0 0 10px rgba(212, 175, 55, 0.8); border-radius: 50%;
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 2px; cursor: pointer; background: #333; }

        /* 按鈕系統 */
        .tab-btn { font-family: 'Cinzel', serif; font-size: 11px; letter-spacing: 0.1em; color: #555; padding: 12px 0; cursor: pointer; transition: 0.3s; border-bottom: 2px solid transparent; text-align: center; width: 33%; }
        .tab-btn.active { color: #D4AF37; border-bottom: 2px solid #D4AF37; text-shadow: 0 0 10px rgba(212,175,55,0.4); }
        .mod-btn { border: 1px solid #333; color: #777; font-family: 'Space Mono'; font-size: 10px; padding: 10px 0; text-align: center; cursor: pointer; transition: all 0.3s; background: #0a0a0a; }
        .mod-btn.active { border-color: #D4AF37; background: rgba(212, 175, 55, 0.1); color: #D4AF37; font-weight: bold; }
        
        /* Toggle */
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider-tg { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 20px; }
        .slider-tg:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: #888; transition: .4s; border-radius: 50%; }
        input:checked + .slider-tg { background-color: #111; border: 1px solid #D4AF37; }
        input:checked + .slider-tg:before { transform: translateX(20px); background-color: #D4AF37; }

        body.lang-en .text-zh { display: none; }
        body.lang-zh .text-en { display: none; }

        /* Status Message */
        #status-msg {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-family: 'Space Mono'; color: #D4AF37; font-size: 10px; z-index: 100;
            pointer-events: none; text-align: center; line-height: 1.5;
            background: rgba(0,0,0,0.8); padding: 10px 20px; border: 1px solid #333;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen lang-en transition-colors duration-500">

    <div id="status-msg">INITIALIZING STUDIO...</div>
    <div id="canvas-container"></div>

    <div id="ui-layer" class="flex flex-col min-h-screen">
        <nav class="w-full flex justify-between items-center px-6 py-5 bg-gradient-to-b from-black/90 to-transparent">
            <a href="index.html" class="text-[10px] tracking-[0.2em] text-[#888] hover:text-[#fff] transition-colors font-mono interactive-el">← EDEN ROOM</a>
            <button id="langBtn" class="border border-[#333] px-3 py-1 text-[9px] font-mono hover:border-[#D4AF37] hover:text-[#D4AF37] transition-colors text-[#666] bg-black/50 backdrop-blur interactive-el">
                <span class="text-en">中 / EN</span><span class="text-zh">EN / 中</span>
            </button>
        </nav>

        <div class="flex-grow"></div>

        <main class="w-full max-w-2xl mx-auto px-6 pb-12 interactive-el">
            <div class="flex justify-between bg-black/80 backdrop-blur-md border border-[#222] mb-6 rounded-sm">
                <div id="tabKey" class="tab-btn active"><span class="text-en">KEY</span><span class="text-zh">主光</span></div>
                <div id="tabFill" class="tab-btn"><span class="text-en">FILL</span><span class="text-zh">補光</span></div>
                <div id="tabRim" class="tab-btn"><span class="text-en">RIM</span><span class="text-zh">輪廓</span></div>
            </div>

            <div id="controlPanel" class="bg-black/80 backdrop-blur-md border border-[#222] p-6 space-y-8 rounded-sm transition-opacity duration-300">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="flex items-center justify-between border-b border-[#333] pb-2">
                        <span class="font-serif text-[10px] text-gray-400 tracking-widest"><span class="text-en">STATUS</span><span class="text-zh">開關狀態</span></span>
                        <label class="toggle-switch interactive-el"><input type="checkbox" id="powerSwitch" checked><span class="slider-tg"></span></label>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2"><span class="font-serif text-[10px] text-gray-400 tracking-widest"><span class="text-en">MODIFIER</span><span class="text-zh">控光配件</span></span></div>
                        <div class="grid grid-cols-4 gap-2">
                            <div class="mod-btn active interactive-el" data-mod="softbox">SOFT</div>
                            <div class="mod-btn interactive-el" data-mod="radar">RADAR</div>
                            <div class="mod-btn interactive-el" data-mod="grid">GRID</div>
                            <div class="mod-btn interactive-el" data-mod="bare">BARE</div>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div>
                        <div class="flex justify-between mb-1"><span class="font-serif text-[10px] text-gray-400 tracking-widest"><span class="text-en">AZIMUTH</span><span class="text-zh">水平位置</span></span><span id="azVal" class="font-mono text-[10px] text-[#D4AF37]">45°</span></div>
                        <input type="range" id="azSlider" min="-180" max="180" step="5" class="interactive-el">
                    </div>
                    <div>
                        <div class="flex justify-between mb-1"><span class="font-serif text-[10px] text-gray-400 tracking-widest"><span class="text-en">ALTITUDE</span><span class="text-zh">垂直高度</span></span><span id="polVal" class="font-mono text-[10px] text-[#D4AF37]">30°</span></div>
                        <input type="range" id="polSlider" min="-40" max="90" step="5" class="interactive-el">
                    </div>
                </div>

                <div class="border-t border-[#333] pt-4">
                    <h3 class="font-serif text-[#D4AF37] text-sm tracking-widest mb-1 font-bold" id="lightName">REMBRANDT</h3>
                    <p class="font-zh text-xs text-gray-400 font-light" id="lightDesc">...</p>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';

        // --- SETUP ---
        const container = document.getElementById('canvas-container');
        const statusMsg = document.getElementById('status-msg');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(35, container.clientWidth / container.clientHeight, 0.1, 100);
        camera.position.set(0, 0, 7); 
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap; 
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.0;
        container.appendChild(renderer.domElement);

        // --- MODEL LOADING SYSTEM (AUTO-FALLBACK) ---
        const loader = new OBJLoader();
        const plasterMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.5, metalness: 0.05, side: THREE.DoubleSide });

        // 嘗試讀取檔案
        const filename = 'face.glb.obj'; // 您指定的檔名

        loader.load(
            filename,
            (object) => {
                // SUCCESS
                console.log("Model loaded successfully!");
                statusMsg.innerText = "MODEL LOADED: " + filename;
                setTimeout(() => statusMsg.style.display = 'none', 2000);
                
                setupModel(object);
            },
            (xhr) => {
                // PROGRESS
                if(xhr.total > 0) {
                     const percent = (xhr.loaded / xhr.total * 100).toFixed(0);
                     statusMsg.innerText = `LOADING EXTERNAL MODEL... ${percent}%`;
                }
            },
            (error) => {
                // FAIL -> FALLBACK TO PROCEDURAL
                console.warn("External model failed. Using procedural fallback.", error);
                statusMsg.innerHTML = "EXTERNAL FILE NOT FOUND<br>SWITCHING TO INTERNAL GENERATOR";
                setTimeout(() => statusMsg.style.display = 'none', 3000);
                
                createFallbackHead();
            }
        );

        function setupModel(model) {
            // 自動縮放與置中 (Auto-Center & Normalize)
            const box = new THREE.Box3().setFromObject(model);
            const size = box.getSize(new THREE.Vector3());
            const center = box.getCenter(new THREE.Vector3());
            
            // 歸零位置
            model.position.x += (model.position.x - center.x);
            model.position.y += (model.position.y - center.y);
            model.position.z += (model.position.z - center.z);

            // 統一大小 (縮放到高度約 3)
            const maxDim = Math.max(size.x, size.y, size.z);
            const scale = 3.0 / maxDim;
            model.scale.set(scale, scale, scale);

            model.traverse((child) => {
                if (child.isMesh) {
                    child.material = plasterMat;
                    child.castShadow = true;
                    child.receiveShadow = true;
                }
            });
            scene.add(model);
        }

        // --- PROCEDURAL FALLBACK HEAD (v11 Logic) ---
        function createFallbackHead() {
            const headGroup = new THREE.Group();
            
            // High-res Sphere
            const geometry = new THREE.SphereGeometry(1.4, 128, 128);
            const pos = geometry.attributes.position;
            const v = new THREE.Vector3();

            for (let i = 0; i < pos.count; i++) {
                v.fromBufferAttribute(pos, i);
                const x = v.x; const y = v.y; const z = v.z;
                
                // Sculpting
                if (y < 0.2 && z > 0) { // Cheeks/Jaw
                    const narrow = Math.max(0, (Math.abs(x) - 0.6)); 
                    v.x *= (1 - narrow * 0.5); 
                    if (y < -0.5) v.z *= 0.85; 
                }
                if (z > 0 && Math.abs(x) < 0.3 && y > -0.3 && y < 0.3) { // Nose
                    const dist = Math.sqrt(x*x + (y+0.1)*(y+0.1));
                    if (dist < 0.3) v.z += Math.cos(dist * Math.PI / 0.6) * 0.5;
                }
                if (z > 0 && Math.abs(x) > 0.2 && Math.abs(x) < 0.7 && y > 0.1 && y < 0.5) { // Eyes
                    v.z -= 0.15; v.y -= 0.05;
                }
                if (z > 0 && Math.abs(x) < 0.8 && y > 0.4 && y < 0.6) v.z += 0.08; // Brow
                
                pos.setXYZ(i, v.x, v.y, v.z);
            }
            geometry.computeVertexNormals();
            
            const head = new THREE.Mesh(geometry, plasterMat);
            head.castShadow = true; head.receiveShadow = true;
            headGroup.add(head);

            // Neck
            const neck = new THREE.Mesh(new THREE.CylinderGeometry(0.65, 0.8, 2.5, 64), plasterMat);
            neck.position.y = -2; neck.castShadow = true; neck.receiveShadow = true;
            headGroup.add(neck);

            // Ears
            const earGeo = new THREE.SphereGeometry(0.35, 32, 32);
            const earL = new THREE.Mesh(earGeo, plasterMat);
            earL.scale.set(0.5, 1.5, 0.5); earL.position.set(-1.3, 0, 0);
            earL.castShadow = true; earL.receiveShadow = true;
            headGroup.add(earL);
            const earR = earL.clone(); earR.position.set(1.3, 0, 0);
            headGroup.add(earR);

            headGroup.rotation.y = 0.1; // Slight turn
            scene.add(headGroup);
        }

        // Environment
        const plane = new THREE.Mesh(new THREE.PlaneGeometry(50, 50), new THREE.MeshStandardMaterial({ color: 0x050505, roughness: 1 }));
        plane.rotation.x = -Math.PI / 2; plane.position.y = -3.5; plane.receiveShadow = true;
        scene.add(plane);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.3);
        scene.add(ambientLight);

        // --- LIGHTS & LOGIC ---
        const lightsData = {
            key: { obj: null, az: 45, pol: 30, on: true, name: "KEY", modifier: 'softbox', color: 0xffffff, intensity: 1.5 },
            fill: { obj: null, az: -45, pol: 10, on: true, name: "FILL", modifier: 'softbox', color: 0xffeedd, intensity: 0.5 },
            rim: { obj: null, az: 135, pol: 30, on: true, name: "RIM", modifier: 'bare', color: 0xffc266, intensity: 1.5 }
        };

        for (const k in lightsData) {
            const data = lightsData[k];
            const light = new THREE.SpotLight(data.color, data.intensity);
            light.castShadow = true;
            light.shadow.mapSize.set(2048, 2048);
            light.shadow.bias = -0.00005;
            scene.add(light);
            light.target.position.set(0, 0, 0);
            scene.add(light.target);
            data.obj = light;
        }

        // UI Logic
        let currentLang = 'en', currentTarget = 'key';
        const els = {
            azSlider: document.getElementById('azSlider'),
            polSlider: document.getElementById('polSlider'),
            powerSwitch: document.getElementById('powerSwitch'),
            azVal: document.getElementById('azVal'),
            polVal: document.getElementById('polVal'),
            lightName: document.getElementById('lightName'),
            lightDesc: document.getElementById('lightDesc'),
            panel: document.getElementById('controlPanel')
        };

        function updateState() {
            const data = lightsData[currentTarget];
            const light = data.obj;
            light.visible = data.on;
            
            if (data.on) {
                const r = 6;
                const phi = (90 - data.pol) * (Math.PI / 180);
                const theta = (data.az + 90) * (Math.PI / 180);
                light.position.set(-(r * Math.sin(phi) * Math.cos(theta)), r * Math.cos(phi), r * Math.sin(phi) * Math.sin(theta));
                
                if (data.modifier === 'softbox') { light.angle = 1.0; light.penumbra = 1.0; }
                if (data.modifier === 'radar') { light.angle = 0.7; light.penumbra = 0.4; }
                if (data.modifier === 'grid') { light.angle = 0.4; light.penumbra = 0.2; }
                if (data.modifier === 'bare') { light.angle = 1.2; light.penumbra = 0.05; }
            }

            // UI
            els.azSlider.value = data.az;
            els.polSlider.value = data.pol;
            els.azVal.innerText = `${data.az}°`;
            els.polVal.innerText = `${data.pol}°`;
            els.powerSwitch.checked = data.on;
            
            document.querySelectorAll('.mod-btn').forEach(b => b.classList.toggle('active', b.dataset.mod === data.modifier));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab${currentTarget.charAt(0).toUpperCase() + currentTarget.slice(1)}`).classList.add('active');
            
            els.panel.style.opacity = data.on ? '1' : '0.5';
            analyze();
        }

        // Listeners
        els.azSlider.oninput = (e) => { lightsData[currentTarget].az = parseInt(e.target.value); updateState(); };
        els.polSlider.oninput = (e) => { lightsData[currentTarget].pol = parseInt(e.target.value); updateState(); };
        els.powerSwitch.onchange = (e) => { lightsData[currentTarget].on = e.target.checked; updateState(); };
        document.querySelectorAll('.mod-btn').forEach(b => b.onclick = (e) => { lightsData[currentTarget].modifier = e.target.dataset.mod; updateState(); });
        
        ['key','fill','rim'].forEach(t => document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).onclick = () => { currentTarget = t; updateState(); });
        document.getElementById('langBtn').onclick = () => { currentLang = currentLang === 'en' ? 'zh' : 'en'; document.body.className = document.body.className.replace(/lang-\w+/, `lang-${currentLang}`); analyze(); };
        
        window.onresize = () => { camera.aspect = container.clientWidth / container.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(container.clientWidth, container.clientHeight); };

        function analyze() {
            const k = lightsData.key;
            let en = "CUSTOM", zh = "自定義", den = "Unique setup.", dzh = "獨特佈光。";
            if (!k.on) { en = "LOW KEY"; zh = "暗調"; dzh = "主光已關閉。"; }
            else {
                const absAz = Math.abs(k.az);
                if (k.pol > 60) { en = "TOP LIGHT"; zh = "頂光"; dzh = "結構感強。"; }
                else if (absAz < 25 && k.pol > 20) { en = "BUTTERFLY"; zh = "蝴蝶光"; dzh = "美顏修飾。"; }
                else if (absAz >= 30 && absAz <= 70) { en = "REMBRANDT"; zh = "倫勃朗光"; dzh = "經典立體感。"; }
                else if (absAz > 70) { en = "SPLIT"; zh = "分割光"; dzh = "戲劇性強。"; }
            }
            els.lightName.innerText = currentLang === 'en' ? en : zh;
            els.lightDesc.innerText = currentLang === 'en' ? den : dzh;
        }

        function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }
        updateState(); animate();
    </script>
</body>
</html>
